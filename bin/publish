#!/usr/bin/perl -w

# To use this script:
#  (1) Edit ~/.bash_profile by setting an environment variable to the folder where you
#      plan to keep your Champlain GIT repositories.  For example, if you use a folder
#      named "Repos" in Dropbox, you would edit bash_profile by adding the following line:
#
#      export CHAMPLAIN_REPO_PATH=~/Dropbox/Repos
#
#  (2) For instructions how to use this script, use publish -h

use Getopt::Std;

my %options = ();
getopts("pshu:", \%options);

chomp( my $username = $options{u} ? $options{u} : `whoami` );
my $local_path = "/home/ec2-user/environment/ben-website/";
my $production_path = "$username\@ben.huwiler.me:/var/www/html/ben/";

$| = 1;

if ( $options{h} ) {
    print <<ENDHELP;
    Author: Matt Huwiler
	Date: 5/10/2016
	Description: Simple deployment script utilizing rsync.
  Usage examples:

  Publish as a user named johndoe
  \$ publish -pu johndoe

  Publish as whatever user you are logged in as on your machine
  \$ publish -p

    Publishes to production server

ENDHELP
}

if ( $options{p} ) {

    chomp( my $branch_name = `git symbolic-ref HEAD 2>/dev/null | cut -d"/" -f 3` );
    if ( $branch_name ne "master" ) {
	print <<ENDERROR;

  You can only publish to production from the master branch.

ENDERROR
exit;
    }

    print "Are you sure you want to publish Ben's Website from Cloud9 ($local_path) to remote ($production_path)? ";
    chomp( my $are_you_sure = <> );

    if ( $are_you_sure eq 'y' || $are_you_sure eq 'yes' ) {
        print "Publishing Ben's Website from $local_path to $production_path...\n";
        `rsync -rltzuvO -e "ssh -i ~/.ssh/aws-huwiler-me.pem" $local_path $production_path --exclude="*application/log/*" --exclude=".*" --exclude="~*" --exclude="*zend_cache*" --exclude="*node_modules*" --exclude="*application/uploads/*"`;
    }

}

if ( $options{s} ) {

    print "Are you sure you want to publish Ben's Website from local ($local_path) to remote ($staging_path)? ";
    chomp( my $are_you_sure = <> );

    if ( $are_you_sure eq 'y' || $are_you_sure eq 'yes' ) {
        print "Publishing Ben's Website from $local_path to $staging_path...\n";
        `rsync -rltzuvO -e "ssh -i ~/.ssh/aws-huwiler-me.pem" $local_path $staging_path --exclude="*application/log/*" --exclude=".*" --exclude="~*" --exclude="*zend_cache*" --exclude="*node_modules*" --exclude="*application/uploads/*"`;
    }

}
